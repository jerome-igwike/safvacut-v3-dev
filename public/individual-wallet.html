<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safvacut - Individual Crypto Wallet</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .orbitron {
            font-family: 'Orbitron', monospace;
        }

        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(247, 147, 30, 0.2);
        }

        .balance-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .crypto-icon-bitcoin {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
        }

        .crypto-icon-ethereum {
            background: linear-gradient(135deg, #627eea 0%, #3c3c3d 100%);
        }

        .crypto-icon-bnb {
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
        }

        .crypto-icon-usdt {
            background: linear-gradient(135deg, #26a17b 0%, #50af95 100%);
        }

        .crypto-icon-trc20 {
            background: linear-gradient(135deg, #ff0013 0%, #ff4757 100%);
        }

        .crypto-icon-solana {
            background: linear-gradient(135deg, #9945ff 0%, #14f195 100%);
        }

        .crypto-icon-doge {
            background: linear-gradient(135deg, #c2a633 0%, #d4af37 100%);
        }

        .crypto-icon-cardano {
            background: linear-gradient(135deg, #0033ad 0%, #1e88e5 100%);
        }

        .crypto-icon-polygon {
            background: linear-gradient(135deg, #8247e5 0%, #a855f7 100%);
        }

        .btn-primary {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #e8851c 0%, #e55a2b 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(247, 147, 30, 0.4);
        }

        .price-up {
            color: #10b981;
        }

        .price-down {
            color: #ef4444;
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 150px;
            }

            .balance-card h1 {
                font-size: 1.5rem !important;
            }

            .balance-card .balance-display {
                font-size: 2rem !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .wallet-details {
                grid-template-columns: 1fr !important;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .action-buttons button {
                width: 100%;
                padding: 1rem;
            }
        }

        /* ETH Warning Modal Styles */
        .eth-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .eth-warning-content {
            background: rgba(15, 15, 35, 0.95);
            border: 1px solid rgba(247, 147, 30, 0.3);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
        }

        .eth-warning-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            animation: pulse 2s infinite;
        }

        .eth-warning-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 1rem;
        }

        .eth-warning-message {
            color: #d1d5db;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .eth-warning-button {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .eth-warning-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(247, 147, 30, 0.4);
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<!-- Start of LiveChat (www.livechat.com) code -->
<script>
    window.__lc = window.__lc || {};
    window.__lc.license = 19326974;
    window.__lc.integration_name = "manual_channels";
    window.__lc.product_name = "livechat";
    ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>
<noscript><a href="https://www.livechat.com/chat-with/19326974/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code -->


<body>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <button onclick="goBack()"
                class="flex items-center space-x-2 text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </button>
            <div class="flex items-center space-x-4">
                <button class="p-2 rounded-lg glass-effect hover:bg-orange-500 hover:bg-opacity-20 transition-all">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="p-2 rounded-lg glass-effect hover:bg-orange-500 hover:bg-opacity-20 transition-all">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Wallet Header -->
        <div class="balance-card glass-effect rounded-3xl p-6 sm:p-8 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                    <div id="wallet-icon" class="crypto-icon w-16 h-16 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-2xl">B</span>
                    </div>
                    <div>
                        <h1 id="wallet-name" class="text-2xl sm:text-3xl font-bold balance-display">Bitcoin Wallet</h1>
                        <p id="wallet-network" class="text-gray-400">Bitcoin Network</p>
                    </div>
                </div>
                <div class="text-right">
                    <div id="wallet-price" class="text-xl font-semibold">$45,234.67</div>
                    <div id="wallet-change" class="text-sm price-up">↗ +2.34%</div>
                </div>
            </div>

            <!-- Balance Display -->
            <div class="text-center mb-8">
                <div id="wallet-balance" class="text-3xl sm:text-5xl font-bold balance-display mb-2">0.00000000 BTC
                </div>
                <div id="wallet-value" class="text-xl sm:text-2xl text-gray-400 mb-6">$0.00</div>

                <!-- Quick Actions -->
                <div
                    class="action-buttons flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="showSendModal()"
                        class="btn-primary px-6 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2">
                        <i class="fas fa-paper-plane"></i>
                        <span>Send</span>
                    </button>
                    <button onclick="showReceiveModal()"
                        class="glass-effect px-6 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2 hover:bg-orange-500 hover:bg-opacity-20 transition-all">
                        <i class="fas fa-qrcode"></i>
                        <span>Receive</span>
                    </button>
                    <button onclick="showSwapModal()"
                        class="glass-effect px-6 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2 hover:bg-orange-500 hover:bg-opacity-20 transition-all">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Swap</span>
                    </button>
                </div>
            </div>

            <!-- Price Chart -->
            <div class="chart-container">
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-effect rounded-2xl p-6 text-center">
                <div class="text-2xl font-bold balance-display mb-2" id="volume-24h">$1,234.56</div>
                <div class="text-sm text-gray-400">24h Volume</div>
                <div class="text-sm text-green-500 mt-1">+15.67%</div>
            </div>
            <div class="glass-effect rounded-2xl p-6 text-center">
                <div class="text-2xl font-bold balance-display mb-2" id="market-cap">$45,890.12</div>
                <div class="text-sm text-gray-400">Market Cap</div>
                <div class="text-sm text-blue-500 mt-1">Rank #1</div>
            </div>
            <div class="glass-effect rounded-2xl p-6 text-center">
                <div class="text-2xl font-bold balance-display mb-2" id="max-supply">21M</div>
                <div class="text-sm text-gray-400">Max Supply</div>
                <div class="text-sm text-orange-500 mt-1">Limited</div>
            </div>
        </div>

        <!-- Wallet Details -->
        <div class="wallet-details grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Wallet Address with Real QR Code -->
            <div class="glass-effect rounded-2xl p-6">
                <h3 class="text-xl font-semibold mb-4">Wallet Address</h3>
                <div class="bg-gray-800 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p id="wallet-address" class="font-mono text-sm break-all">
                                bc1qr6vn5w2mxnm33cwtpm8tnvenvnwx4unu8szn0z</p>
                        </div>
                        <button onclick="copyAddress()"
                            class="ml-3 p-2 rounded-lg hover:bg-orange-500 hover:bg-opacity-20 transition-all">
                            <i class="fas fa-copy text-orange-500"></i>
                        </button>
                    </div>
                </div>
                <!-- Real QR Code -->
                <div class="text-center mt-4">
                    <div class="inline-block bg-white p-4 rounded-lg">
                        <img id="qr-code"
                            src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BTC%28Bitcoin%29.JPG-5Oh8mFt67VGb9kAiYSmbP5hD0UgM09.jpeg"
                            alt="Bitcoin QR Code" class="w-32 h-32">
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold">Recent Transactions</h3>
                    <button class="text-orange-500 hover:text-orange-400 text-sm font-medium">View All</button>
                </div>
                <div id="transactions-list" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- ETH Warning Modal -->
    <div id="eth-warning-modal" class="eth-warning-modal" style="display: none;">
        <div class="eth-warning-content">
            <div class="eth-warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="eth-warning-title">Warning?</h3>
            <p class="eth-warning-message">
                You do not have enough ETHEREUM(ERC20) to cover your network fees!
            </p>
            <button class="eth-warning-button" onclick="closeEthWarning()">
                Understood
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase Config
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            collection,
            query,
            where,
            orderBy,
            limit,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD6enbTO-nNYVyrNLRP-Av6ghguL3--Nvw",
            authDomain: "safvacut-web-wallet.firebaseapp.com",
            projectId: "safvacut-web-wallet",
            storageBucket: "safvacut-web-wallet.appspot.com",
            messagingSenderId: "976916444641",
            appId: "1:976916444641:web:4c6a6ad09c43a7ccda0ea0",
            measurementId: "G-0QCL2TQCB6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userWalletData = {
            balances: {},
            transactions: [],
            totalValue: 0
        };

        // Real wallet addresses with QR codes
        const walletAddresses = {
            BTC: {
                address: 'bc1qr6vn5w2mxnm33cwtpm8tnvenvnwx4unu8szn0z',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BTC%28Bitcoin%29.JPG-5Oh8mFt67VGb9kAiYSmbP5hD0UgM09.jpeg'
            },
            ETH: {
                address: '0xD2B475710CCd8a48B2fD20Ff7D8cd5360c428ba2',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/ETH.JPG-erHe6KpUosJF7pe7gTWj5nTma6YvxY.jpeg'
            },
            BNB: {
                address: '0xFc940b52E7E5feb789becbf3ca47804C29aa3D82',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/IMG_20250731_205556_092.jpg-diPF62mf4bwtVUYHgebQqYdXHt2x7A.jpeg'
            },
            USDT: {
                address: '0xD2B475710CCd8a48B2fD20Ff7D8cd5360c428ba2',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/USDT%28Etherum%29.JPG-7uCAepLluINt17QRDHHmbiQa0XYBbB.jpeg'
            },
            TRC20: {
                address: 'TZ359zm5ixt1LcwSVZNErBGqq JujBhiX8e',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/USDT%28Tron%29.JPG-4SkUFz7ualnfnhJ2NEyDJbjxltBdBE.jpeg'
            },
            ADA: {
                address: 'addr1q9jjkfw7wjqle004ax8xjcs6evydtws5k699yd9qgv9j9hnjuxyhel0qz0r4pyr9f30m8nqnffkc25xv4h5prqw90mjash0wk09',
                qrImage: 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/IMG_20250731_205551_653.jpg-2tWDwkOKJUpZTsjklkTXBrvPVnT5Cx.jpeg'
            }
        };

        // Real-time crypto data
        let cryptoData = {};
        let realTimePrices = {};

        // Fetch real-time crypto prices from CoinGecko API
        async function fetchRealTimePrices() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,tether,solana,dogecoin,cardano,matic-network&vs_currencies=usd&include_24hr_change=true&include_market_cap=true&include_24hr_vol=true');
                const data = await response.json();

                realTimePrices = {
                    BTC: {
                        price: data.bitcoin.usd,
                        change: data.bitcoin.usd_24h_change,
                        marketCap: data.bitcoin.usd_market_cap,
                        volume24h: data.bitcoin.usd_24h_vol
                    },
                    ETH: {
                        price: data.ethereum.usd,
                        change: data.ethereum.usd_24h_change,
                        marketCap: data.ethereum.usd_market_cap,
                        volume24h: data.ethereum.usd_24h_vol
                    },
                    BNB: {
                        price: data.binancecoin.usd,
                        change: data.binancecoin.usd_24h_change,
                        marketCap: data.binancecoin.usd_market_cap,
                        volume24h: data.binancecoin.usd_24h_vol
                    },
                    USDT: {
                        price: data.tether.usd,
                        change: data.tether.usd_24h_change,
                        marketCap: data.tether.usd_market_cap,
                        volume24h: data.tether.usd_24h_vol
                    },
                    TRC20: {
                        price: data.tether.usd,
                        change: data.tether.usd_24h_change,
                        marketCap: data.tether.usd_market_cap,
                        volume24h: data.tether.usd_24h_vol
                    },
                    ADA: {
                        price: data.cardano.usd,
                        change: data.cardano.usd_24h_change,
                        marketCap: data.cardano.usd_market_cap,
                        volume24h: data.cardano.usd_24h_vol
                    }
                };

                // Update crypto data
                cryptoData = {
                    BTC: {
                        name: 'Bitcoin',
                        symbol: 'BTC',
                        network: 'Bitcoin Network',
                        price: realTimePrices.BTC.price,
                        change: realTimePrices.BTC.change,
                        marketCap: realTimePrices.BTC.marketCap,
                        volume24h: realTimePrices.BTC.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.BTC.address,
                        qrImage: walletAddresses.BTC.qrImage,
                        iconClass: 'crypto-icon-bitcoin',
                        maxSupply: '21M'
                    },
                    ETH: {
                        name: 'Ethereum',
                        symbol: 'ETH',
                        network: 'Ethereum Network',
                        price: realTimePrices.ETH.price,
                        change: realTimePrices.ETH.change,
                        marketCap: realTimePrices.ETH.marketCap,
                        volume24h: realTimePrices.ETH.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.ETH.address,
                        qrImage: walletAddresses.ETH.qrImage,
                        iconClass: 'crypto-icon-ethereum',
                        maxSupply: 'No Limit'
                    },
                    BNB: {
                        name: 'BNB',
                        symbol: 'BNB',
                        network: 'BSC Network',
                        price: realTimePrices.BNB.price,
                        change: realTimePrices.BNB.change,
                        marketCap: realTimePrices.BNB.marketCap,
                        volume24h: realTimePrices.BNB.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.BNB.address,
                        qrImage: walletAddresses.BNB.qrImage,
                        iconClass: 'crypto-icon-bnb',
                        maxSupply: '200M'
                    },
                    USDT: {
                        name: 'Tether (ERC20)',
                        symbol: 'USDT',
                        network: 'Ethereum Network',
                        price: realTimePrices.USDT.price,
                        change: realTimePrices.USDT.change,
                        marketCap: realTimePrices.USDT.marketCap,
                        volume24h: realTimePrices.USDT.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.USDT.address,
                        qrImage: walletAddresses.USDT.qrImage,
                        iconClass: 'crypto-icon-usdt',
                        maxSupply: 'No Limit'
                    },
                    TRC20: {
                        name: 'Tether (TRC20)',
                        symbol: 'TRC20',
                        network: 'Tron Network',
                        price: realTimePrices.TRC20.price,
                        change: realTimePrices.TRC20.change,
                        marketCap: realTimePrices.TRC20.marketCap,
                        volume24h: realTimePrices.TRC20.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.TRC20.address,
                        qrImage: walletAddresses.TRC20.qrImage,
                        iconClass: 'crypto-icon-trc20',
                        maxSupply: 'No Limit'
                    },
                    ADA: {
                        name: 'Cardano',
                        symbol: 'ADA',
                        network: 'Cardano Network',
                        price: realTimePrices.ADA.price,
                        change: realTimePrices.ADA.change,
                        marketCap: realTimePrices.ADA.marketCap,
                        volume24h: realTimePrices.ADA.volume24h,
                        balance: 0, // Production ready - starts at 0
                        address: walletAddresses.ADA.address,
                        qrImage: walletAddresses.ADA.qrImage,
                        iconClass: 'crypto-icon-cardano',
                        maxSupply: '45B'
                    }
                };

                // Update UI with real data
                updateWalletUI();
            } catch (error) {
                console.error('Error fetching real-time prices:', error);
                // Fallback to mock data if API fails
                initializeFallbackData();
            }
        }

        // Fallback data if API fails
        function initializeFallbackData() {
            cryptoData = {
                BTC: {
                    name: 'Bitcoin',
                    symbol: 'BTC',
                    network: 'Bitcoin Network',
                    price: 45234.67,
                    change: 2.34,
                    marketCap: 890000000000,
                    volume24h: 25000000000,
                    balance: 0, // Production ready - starts at 0
                    address: walletAddresses.BTC.address,
                    qrImage: walletAddresses.BTC.qrImage,
                    iconClass: 'crypto-icon-bitcoin',
                    maxSupply: '21M'
                },
                ETH: {
                    name: 'Ethereum',
                    symbol: 'ETH',
                    network: 'Ethereum Network',
                    price: 2834.12,
                    change: -1.23,
                    marketCap: 340000000000,
                    volume24h: 15000000000,
                    balance: 0, // Production ready - starts at 0
                    address: walletAddresses.ETH.address,
                    qrImage: walletAddresses.ETH.qrImage,
                    iconClass: 'crypto-icon-ethereum',
                    maxSupply: 'No Limit'
                }
            };
        }

        // Load user wallet data from Firebase - ENHANCED
        async function loadUserWalletData() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().walletData) {
                    userWalletData = userDocSnap.data().walletData;
                } else {
                    // Initialize empty wallet data
                    userWalletData = {
                        balances: {},
                        transactions: [],
                        totalValue: 0
                    };
                }

                // Load transactions from separate collection
                await loadTransactionsFromFirestore();
            } catch (error) {
                console.error('Error loading wallet data:', error);
                userWalletData = {
                    balances: {},
                    transactions: [],
                    totalValue: 0
                };
            }
        }

        // Load transactions from Firestore - ENHANCED
        async function loadTransactionsFromFirestore() {
            if (!currentUser) return;

            try {
                const transactionsRef = collection(db, "transactions");
                const q = query(
                    transactionsRef,
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc"),
                    limit(50)
                );

                const querySnapshot = await getDocs(q);
                const transactions = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Convert Firestore timestamp to Date
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate();
                    }
                    transactions.push(data);
                });

                userWalletData.transactions = transactions;
                return transactions;
            } catch (error) {
                console.error('Error loading transactions:', error);
                return [];
            }
        }

        // Critical ETH Balance Check Function
        function checkEthBalance() {
            const ethBalance = userWalletData.balances['ETH'] || 0;
            const minimumEthRequired = 0.7; // 0.7 ETH minimum requirement

            if (ethBalance < minimumEthRequired) {
                showEthWarning();
                return false;
            }
            return true;
        }

        function showEthWarning() {
            document.getElementById('eth-warning-modal').style.display = 'flex';
        }

        function closeEthWarning() {
            document.getElementById('eth-warning-modal').style.display = 'none';
        }

        // Make closeEthWarning globally available
        window.closeEthWarning = closeEthWarning;

        // Initialize wallet - ENHANCED WITH FIREBASE INTEGRATION
        function initializeWallet() {
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol') || 'BTC';
            const uid = urlParams.get('uid');

            // Check authentication
            onAuthStateChanged(auth, async (user) => {
                if (user && (uid === user.uid || !uid)) {
                    currentUser = user;
                    await loadUserWalletData();

                    // Fetch real-time data first
                    await fetchRealTimePrices();

                    const crypto = cryptoData[symbol];
                    if (!crypto) {
                        window.location.href = 'dashboard.html';
                        return;
                    }

                    // Update crypto balance from user data
                    crypto.balance = userWalletData.balances[symbol] || 0;

                    updateWalletDisplay(crypto);
                    loadTransactions(symbol);
                    initializeChart(crypto);
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });

            // Update prices every 30 seconds
            setInterval(fetchRealTimePrices, 30000);
        }

        function updateWalletDisplay(crypto) {
            // Update UI
            document.getElementById('wallet-icon').className = `crypto-icon w-16 h-16 rounded-full flex items-center justify-center ${crypto.iconClass}`;
            document.getElementById('wallet-icon').innerHTML = `<span class="text-white font-bold text-2xl">${crypto.symbol.charAt(0)}</span>`;
            document.getElementById('wallet-name').textContent = `${crypto.name} Wallet`;
            document.getElementById('wallet-network').textContent = crypto.network;
            document.getElementById('wallet-price').textContent = `$${crypto.price.toLocaleString()}`;
            document.getElementById('wallet-change').textContent = `${crypto.change >= 0 ? '↗' : '↘'} ${crypto.change >= 0 ? '+' : ''}${crypto.change.toFixed(2)}%`;
            document.getElementById('wallet-change').className = `text-sm ${crypto.change >= 0 ? 'price-up' : 'price-down'}`;
            document.getElementById('wallet-balance').textContent = `${crypto.balance.toFixed(8)} ${crypto.symbol}`;
            document.getElementById('wallet-value').textContent = `$${(crypto.balance * crypto.price).toLocaleString()}`;
            document.getElementById('wallet-address').textContent = crypto.address;

            // Update QR code with real image
            document.getElementById('qr-code').src = crypto.qrImage;
            document.getElementById('qr-code').alt = `${crypto.symbol} QR Code`;

            // Update stats with real data
            if (crypto.volume24h) {
                document.getElementById('volume-24h').textContent = `$${(crypto.volume24h / 1000000).toFixed(1)}M`;
            }
            if (crypto.marketCap) {
                document.getElementById('market-cap').textContent = `$${(crypto.marketCap / 1000000000).toFixed(1)}B`;
            }
            document.getElementById('max-supply').textContent = crypto.maxSupply;
        }

        function updateWalletUI() {
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol') || 'BTC';
            const crypto = cryptoData[symbol];
            if (crypto && currentUser) {
                // Update balance from user data
                crypto.balance = userWalletData.balances[symbol] || 0;
                updateWalletDisplay(crypto);
            }
        }

        // Load transactions for specific asset - ENHANCED
        function loadTransactions(symbol) {
            const container = document.getElementById('transactions-list');
            container.innerHTML = '';

            // Filter transactions for this specific asset
            const assetTransactions = userWalletData.transactions.filter(tx => tx.asset === symbol);

            if (assetTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-history text-3xl mb-3"></i>
                        <p>No ${symbol} transactions yet</p>
                        <p class="text-sm mt-2">Your ${symbol} transaction history will appear here</p>
                    </div>
                `;
                return;
            }

            assetTransactions.slice(0, 10).forEach(tx => {
                const statusClass = `status-${tx.status}`;
                const typeIcon = tx.type === 'send' ? 'fa-paper-plane' : tx.type === 'receive' ? 'fa-arrow-down' : 'fa-credit-card';
                const typeColor = tx.type === 'send' ? 'bg-red-500 bg-opacity-20' : tx.type === 'receive' ? 'bg-green-500 bg-opacity-20' : 'bg-blue-500 bg-opacity-20';
                const timeAgo = getTimeAgo(tx.timestamp);

                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 glass-effect rounded-lg hover:bg-orange-500 hover:bg-opacity-10 transition-all">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${typeColor}">
                                <i class="fas ${typeIcon} text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="font-medium capitalize text-sm">${tx.type}</div>
                                <div class="text-xs text-gray-400">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium text-sm ${tx.type === 'send' ? 'text-red-400' : 'text-green-400'}">
                                ${tx.type === 'send' ? '-' : '+'}${tx.amount} ${tx.asset}
                            </div>
                            <div class="text-xs ${statusClass} px-2 py-1 rounded-full">${tx.status}</div>
                        </div>
                    </div>
                `;
            });
        }

        // Get time ago string
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Initialize chart
        function initializeChart(crypto) {
            const ctx = document.getElementById('price-chart');
            if (ctx) {
                // Generate mock price data based on current price
                const basePrice = crypto.price;
                const priceData = [];
                for (let i = 0; i < 24; i++) {
                    const variation = (Math.random() - 0.5) * 0.1; // ±5% variation
                    priceData.push(basePrice * (1 + variation));
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [{
                            label: `${crypto.symbol} Price`,
                            data: priceData,
                            borderColor: '#f7931e',
                            backgroundColor: 'rgba(247, 147, 30, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        }

        // Global functions
        window.goBack = function () {
            window.location.href = 'dashboard.html';
        };

        window.copyAddress = function () {
            const address = document.getElementById('wallet-address').textContent;
            navigator.clipboard.writeText(address).then(() => {
                // Show success message
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                }, 2000);
            });
        };

        window.showSendModal = function () {
            // Check ETH balance before allowing send
            if (!checkEthBalance()) {
                return;
            }
            // Show send modal implementation
            alert('Send modal would open here');
        };

        window.showReceiveModal = function () {
            // Show receive modal implementation
            alert('Receive modal would open here');
        };

        window.showSwapModal = function () {
            // Show swap modal implementation
            alert('Swap modal would open here');
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeWallet();
        });
    </script>
</body>

</html>


